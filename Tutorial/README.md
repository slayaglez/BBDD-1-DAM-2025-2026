# slayacount-db
## Guía paso a paso

### Paso 1
Al preparar nuestro entorno, primero debemos tener descargado Docker en nuestra máquina. Empezaremos usando los siguientes comandos:
`docker run --name spyproduct-db   -e POSTGRES_PASSWORD=1234   -v postgres-data:/var/lib/postgresql/data   -d postgres`
Para crear nuestro contenedor Docker con una imagen base Postgres, donde:
-**"--name"** será el nombre del contenedor
-**"-e POSTGRES_PASSWORD=1234"** será la contraseña postgres (único argumento obligatorio)
-**"-v postgres-data:/var/lib/postgresql/data"** será donde guardemos los volúmenes de nuestro contenedor (guardado del progreso)
-**"-d postgres"** será la imagen base de nuestro contenedor

Tras esto usamos `docker ps` para comprobar que el contenedor se está ejecutando y en caso de que así sea usaremos:
`docker exec -it spyproduct-db psql -U postgres -d spyproduct`
Donde **"-U postgres"** será el usuario (como no lo especificamos antes, por defecto es postgres) y **"-d spyproduct"** será nuestra base de datos. Esto nos dejará con la siguiente terminal:
<img src="../img/cap1.png">

### Paso 2
Saldremos del contenedor con `\q` y activaremos los volúmenes para que nuestro trabajo dentro de la base de datos se guarde y no se reinicie cada vez que paremos e iniciemos el contenedor. Para ello usaremos el siguiente comando: 
`docker volume create postgres-data` y para comprobar que haya funcionado usaremos `docker volume inspect postgres-data` Nuestra consola debe imprimir información de nuestro volumen, parecida a esta:
<img src="../img/cap2.png">

Ahora podemos volver a abrir nuestro contenedor con `docker exec -it spyproduct-db psql -U postgres -d spyproduct` y empezar a crear las tablas e insertar los datos de las mismas.

### Paso 3
Para la creación de tablas copiaremos las siguientes sentencias en postgres en nuestra terminal `spyproduct=# `

```
CREATE TABLE IF NOT EXISTS "users" (
	"id_users" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"name" VARCHAR(255),
	"email" VARCHAR(255),
	PRIMARY KEY("id_users")
);




CREATE TABLE IF NOT EXISTS "groups" (
	"id_groups" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"name" VARCHAR(255) NOT NULL,
	"purpose" VARCHAR(255),
    "created_in" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY("id_groups")
);




CREATE TABLE IF NOT EXISTS "users_groups" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"id_users_fk" INTEGER,
	"id_groups_fk" INTEGER,
	"user_balance" REAL NOT NULL DEFAULT 0,
	"id_expenses_fk" INTEGER,
	PRIMARY KEY("id")
);




CREATE TABLE IF NOT EXISTS "expenses" (
	"id_expenses" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"created_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	"amount" REAL NOT NULL,
	"created_by_fk" INTEGER NOT NULL,
	"description" VARCHAR(255),
	"currency" VARCHAR(255),
	PRIMARY KEY("id_expenses")
);



ALTER TABLE "users_groups"
ADD FOREIGN KEY("id_users_fk") REFERENCES "users"("id_users")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "users_groups"
ADD FOREIGN KEY("id_groups_fk") REFERENCES "groups"("id_groups")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "expenses"
ADD FOREIGN KEY("created_by_fk") REFERENCES "users"("id_users")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "users_groups"
ADD FOREIGN KEY("id_expenses_fk") REFERENCES "expenses"("id_expenses")
ON UPDATE NO ACTION ON DELETE NO ACTION;
```
Con esto todas las tablas y relaciones estarán construidas.

### Paso 4
Ahora tendremos que introducir nuestra información, que puede ser al gusto pero aquí dejo una por defecto:

```
INSERT INTO users(name, email)
VALUES
('Johan', 'johanjohan@sample.com'),
('JuanPabloxx', 'skillstopcanarias@ganador.es'),
('Somilinator', 'xxsomilxx@sample.com');

INSERT INTO groups(name, purpose)
VALUES
('Supernenes', 'Salida');


INSERT INTO expenses (amount, description, currency, created_by)
VALUES
('34.90', 'cita romantica', 'francos suizos', '1');


INSERT INTO users_groups (id_users_fk, id_groups_fk, id_expenses_fk, user_balance)
VALUES
(1, 1, 3, 17.45),
(2, 1, 3, -17.45);

INSERT INTO expenses (amount, description, currency, created_by)
VALUES
('60.90', 'infidelidad en la bolera', 'francos suizos', '2');


INSERT INTO users_groups (id_users_fk, id_groups_fk, id_expenses_fk, user_balance)
VALUES
(3, 1, 2, -30.45),
(2, 1, 2, 30.45);
```
Con esto ya tendremos nuestra base de datos, preparada para su uso. Una vez terminemos de usarla saldremos con `\q` y pararemos el contenedor Docker con `docker stop spyproduct-db` para encenderlo de nuevo usaremos `docker start spyproduct-db` y ejecutaremos el contenedor para acceder a la base de datos con `docker exec -it spyproduct-db psql -U postgres -d spyproduct` ya mencionado anteriormente.

